services:
  # 后端大脑：不再对公网开放 8000 端口
  backend:
    build: ./backend
    # ports 删掉，不让外面直接访问
    env_file: ./backend/.env
    volumes:
      - ./backend:/app

  # 前端界面：不再对公网开放 3000 端口
  frontend:
    build: ./frontend
    # ports 删掉，只允许代理访问
    env_file: ./frontend/.env
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules

  # 新增的“安全岗亭”：唯一对外开放的入口
 # 新增的“安全岗亭”：唯一对外开放的入口
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    ports:
      - "4180:4180"
    # --- 关键改动 1: 显式指定读取根目录的 .env 文件 ---
    env_file:
      - .env
    environment:
      # --- 关键改动 2: 保持变量名对齐 ---
      OAUTH2_PROXY_PROVIDER: "github"
      # 注意：这里直接引用 .env 里的变量，不需要再加引号和 ${}
      OAUTH2_PROXY_CLIENT_ID: ${GITHUB_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      OAUTH2_PROXY_UPSTREAMS: "http://frontend:3000"
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
      OAUTH2_PROXY_REDIRECT_URL: "http://localhost:4180/oauth2/callback"
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
    depends_on:
      - frontend
      - backend