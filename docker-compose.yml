version: '3.8'

services:
  # [新增] 数据库服务 (PostgreSQL)
  db:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: ana_user
      POSTGRES_PASSWORD: secure_password_123
      POSTGRES_DB: ana_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432" # 开发模式暴露端口，方便调试

  # [修改] 后端服务
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      # 告诉后端数据库在哪里 (host: db)
      DATABASE_URL: postgresql://ana_user:secure_password_123@db:5432/ana_db
      # 前端地址
      FRONTEND_URL: "http://localhost:3000"
      # JWT 密钥 (随便写一个复杂的)
      SECRET_KEY: "change_this_to_a_very_long_random_secret_string"
    depends_on:
      - db
    volumes:
      - ./backend:/app

  # [修改] 前端服务
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      # 在 Docker 内部构建时可能需要，但也需要在浏览器运行时生效
      - REACT_APP_API_URL=http://localhost:8000/api
      - CHOKIDAR_USEPOLLING=true # Windows下Docker的热重载补丁
    volumes:
      - ./frontend:/app
      - /app/node_modules

volumes:
  postgres_data: